<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon"
        href="data:image/x-icon;base64,data:image/png;base64,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">

    <link rel="manifest" href="manifest.json" crossorigin="use-credentials" />
    <title>TERMOx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Mitr:wght@200;300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Mitr:wght@200;300;400;500;600;700&display=swap');
    </style>
</head>

<body class="flex flex-col items-center justify-center font-mitr font-semibold text-lg min-h-screen bg-slate-700 p-4">
    <div id="modal"></div>
    <h1 class="text-4xl font-semibold font-[Mitr] text-white mb-4 tracking-wider">TERMOx</h1>
    <nav class="mb-6 space-x-4 flex justify-center">
        <a href="/" class="text-blue-500 hover:underline">
            Termo
        </a>
        <a href="/?q=2" class="text-blue-500 hover:underline">
            Dueto
        </a>
        <a href="/?q=4" class="text-blue-500 hover:underline">
            Quarteto
        </a>
    </nav>

    <div class="grid grid-rows-6 gap-2 mb-4" id="game-grid">
        <script>
            for (let row = 0; row < 6; row++) {
                document.write('<div class="grid grid-cols-5 gap-2" data-row="' + row + '">');
                for (let col = 0; col < 5; col++) {
                    const disabledClass = row === 0 ? "" : "bg-slate-500 opacity-50 border-slate-500";
                    document.write(`
                        <div class="size-12 border-4 text-3xl text-center flex items-center justify-center text-white uppercase rounded-md ${disabledClass}"
                            data-row="${row}" data-col="${col}">
                        </div>
                    `);
                }
                document.write('</div>');
            }
        </script>
    </div>

    <div id="keyboard">
        <div id="keyboard-buttons" class="grid grid-cols-10 gap-2 max-w-md"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        let gameEnded = false

        const gameGrid = document.getElementById("game-grid");
        const rows = gameGrid.getElementsByClassName("grid");
        let currentRow = 0;
        let currentCol = 0;

        const MAX_COLS = 5
        const MAX_ROWS = 6
        const keys = "QWERTYUIOPASDFGHJKLZXCVBNM";

        const classes = {
            base: ["text-white", "font-[Mitr]", "cursor-pointer", "font-semibold", "rounded-md", "opacity-100"],
            button: ["p-2", "text-white", "w-10", "h-10", "bg-slate-600", "rounded", "font-semibold", "font-[Mitr]", "last:w-fit"],
            correct: ["bg-lime-500", "border-lime-500"],
            present: ["bg-yellow-500", "border-yellow-500"],
            used: ["bg-slate-900", "border-slate-900", "bg-opacity-30"],
            incorrect: ["bg-slate-500", "border-slate-500"],
            active: ["bg-transparent", "border-slate-500"],
            focus: ["border-white"]
        }

        function applyClass(element, type) {
            element.classList.remove(...Object.values(classes).flat());
            element.classList.add(...classes.base, ...classes[type]);
        }

        const keyboard = document.getElementById("keyboard")
        const keyboardButtons = document.getElementById("keyboard-buttons");

        function createKeyboardButton(text, key) {
            const button = document.createElement("button");
            button.textContent = text;
            button.dataset.key = key;
            button.classList.add(...classes.button);
            keyboardButtons.appendChild(button);
        }

        const updatedKeys = [...keys].slice(0, 19)
            .concat(["Backspace"])
            .concat([...keys].slice(19))
            .concat(["Enter"]);

        updatedKeys.forEach((key) => {
            createKeyboardButton(key === "Backspace" ? "←" : key, key);
        });

        function updateFocus() {
            Array.from(rows[currentRow].children).forEach((cell, index) => {
                applyClass(cell, index === currentCol ? "focus" : "active");
            });
        }

        function handleBackspace() {
            const cell = rows[currentRow].children[currentCol];
            if (cell.textContent !== "") {
                cell.textContent = "";
            }
            if (currentCol > 0) {
                currentCol--
            }
            updateFocus();
        }

        async function handleEnter() {
            const word = Array.from(rows[currentRow].children).map(cell => cell.textContent.trim()).join("");
            if (!isValidWord(word)) {
                shakeRow(currentRow);
                return;
            }
            await Promise.all(chosen.map((chosenWord) => flipCells(currentRow, chosenWord)));

            if (chosen.includes(word)) {
                gameEnded = true;
                await fetchModal()
            } else if (currentRow + 1 < MAX_ROWS) {
                currentRow++;
                currentCol = 0;
                updateFocus();
            }
        }

        let wordSet = new Set()

        fetch("./wordlist").then(res => res.text())
            .then(data => {
                wordSet = new Set(data.split("\n").map(word => word.trim().toUpperCase()));
            });

        const isValidWord = (word) => wordSet.has(word.toUpperCase());

        const params = new URLSearchParams(window.location.search);
        const q = params.get("q") ?? 1;

        async function fetchWord() {
            const res = await fetch("/word")
            const word = await res.text()
            return word
        }

        let chosen = [];

        async function startGame() {
            for (let i = 0; i < q; i++) {
                chosen.push(await fetchWord());
            }
        }

        function shakeRow(rowIndex) {
            Array.from(rows[rowIndex].children).forEach(cell => {
                cell.classList.add("animate-bounce");
                setTimeout(() => {
                    cell.classList.remove("animate-bounce");
                }, 500);
            });
        }

        function flipCells(rowIndex, chosenWord) {
            const row = rows[rowIndex].children;
            const wordArray = Array.from(row).map(cell => cell.textContent.trim());

            const flipPromises = wordArray.map((letter, index) => {
                const cell = row[index];
                const keyboardKey = keyboard.querySelector(`[data-key="${letter}"]`);

                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (chosenWord[index] === letter) {
                            applyClass(cell, "correct");
                            applyClass(keyboardKey, "correct");
                        } else if (chosenWord.includes(letter)) {
                            applyClass(cell, "present");
                            if (!keyboardKey.classList.contains("bg-lime-500")) {
                                applyClass(keyboardKey, "present");
                            }
                        } else {
                            applyClass(cell, "incorrect");
                            applyClass(keyboardKey, "used");
                        }
                        resolve();
                    }, index * 450);
                });
            });

            return Promise.all(flipPromises);
        }

        function selectCell(rowIndex, colIndex) {
            currentRow = rowIndex;
            currentCol = colIndex;
            updateFocus();
        }

        function write(value) {
            if (gameEnded) return;
            if (value === "BACKSPACE") return handleBackspace();
            if (value === "ENTER") return handleEnter();

            if (keys.includes(value) && currentCol < MAX_COLS) {
                const cell = rows[currentRow].children[currentCol];
                cell.textContent = value;
                if (currentCol + 1 < MAX_COLS) currentCol++;
            }

            updateFocus();
        }

        Array.from(rows).forEach((row, rowIndex) => {
            row.addEventListener("click", (event) => write);
        });

        document.addEventListener("keydown", (event) => {
            if (event.ctrlKey || event.metaKey) {
                if (keys.includes(event.key.toUpperCase()) || ["BACKSPACE", "ENTER"].includes(event.key.toUpperCase())) {
                    return;
                }
            }
            const key = event.key.toUpperCase();
            if (keys.includes(key) || ["BACKSPACE", "ENTER"].includes(key)) write(key);
        });

        keyboard.addEventListener("click", (event) => {
            const key = event.target.dataset.key;
            if (key) write(key);
        });

        Array.from(rows).forEach((row, rowIndex) => {
            row.addEventListener("click", (event) => {
                const cellIndex = Array.from(row.children).indexOf(event.target);
                if (cellIndex !== -1) selectCell(rowIndex, cellIndex);
            });
        });

        updateFocus();
        startGame();

        async function fetchModal() {
            const res = await fetch("./modal.html")
            const modal = await res.text()

            const modalElement = document.getElementById("modal")
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = modal;

            modalElement.appendChild(tempDiv.firstElementChild);

            let word = '';
            const row = rows[currentRow].children;

            for (let i = 0; i < row.length; i++) {
                word += row[i].textContent.trim();
            }

            const resultMessage = document.getElementById("game-result-message");
            const attemptsText = document.getElementById("attempts-text");
            const revealedWord = document.getElementById("revealed-word");

            if (gameEnded) {
                if (chosen.includes(word)) {
                    resultMessage.textContent = "Great job! You guessed the word.";
                    attemptsText.textContent = `You solved it in ${currentRow + 1} attempts. Well done!`;
                    revealedWord.innerHTML = `<span class="text-gray-500 font-semibold">The word was: </span><span id="actual-word" class="font-semibold">${word}</span>`;
                    revealedWord.classList.add("text-2xl", "font-bold");
                } else {
                    resultMessage.textContent = "Game Over! Better luck next time!";
                    attemptsText.textContent = `You reached the max attempts (${MAX_ROWS}). Keep practicing!`;
                    revealedWord.textContent = word;
                    revealedWord.classList.add("text-6xl", "font-extrabold", "text-red-500");
                }
            }
        }
    })
</script>

</html>
